# Contributor: Yichun Zhang <admin@openresty.com>
# Maintainer: Yichun Zhang <admin@openresty.com>
pkgname="lua-resty-jsonb"
pkgver="0.0.5"
pkgrel=0
pkgdesc="Lua module for manipulating jsonb data"
url="http://www.openresty.com/"
arch="all"
license="Proprietary"
depends="openresty-yajl>=2.1.0.4-r1"
makedepends="ccache openresty-yajl-dev>=2.1.0.4-r1 openresty"
#install=""
subpackages="$pkgname-dbg"
#subpackages="$pkgname-static $pkgname-dev $pkgname-dbg"
source="lua-resty-jsonb-$pkgver.tar.gz"
options="!tracedeps !fhs"
builddir="$srcdir/lua-resty-jsonb-$pkgver"

orprefix=/usr/local/openresty
_jsonb_prefix=/usr/local/openresty/site

build() {
    export CC="ccache gcc -fdiagnostics-color=always -g3"
    export CFLAGS=
    export CXXFLAGS=
    export CPPFLAGS=
    export LDFLAGS=

    make -j$JOBS YAJL="/usr/local/openresty-yajl" \
        CC='ccache gcc -fdiagnostics-color=always'

    for f in `find lib/resty/ -type f -name '*.lua'`; do
        $orprefix/luajit/bin/luajit -bg $f ${f%.lua}.ljbc
        rm $f
    done
}

check() {
	:
}

package() {
    sed -i 's|lib/resty/\*.lua|lib/resty/\*.ljbc|g' Makefile
    make install DESTDIR="$pkgdir"
    rm -rf $pkgdir/$_jsonb_prefix/share
}

static() {
    if ! is_function default_static; then
        local i= devpkg

        # search for -dev package matching our prefix
        if [ -z "$depends_static" ]; then
            devpkg="${subpkgname%-libs-static}"
            devpkg="${devpkg%-static}"
            devpkg="$devpkg-dev"
            if subpackages_has "$devpkg"; then
                depends_static="$devpkg"
            fi
        fi

        depends="$depends_static"
        pkgdesc="$pkgdesc (static library)"

        cd "$pkgdir" || return 0
        local libdirs=usr/lib
        [ -d lib/ ] && libdirs="lib/ $libdirs"

        # move *.a static library
        for i in $(find $libdir -name '*.a'); do
            mkdir -p "$subpkgdir"/"${i%/*}"
            mv "$i" "$subpkgdir/$i" || return 1
        done
        return 0
    fi

    default_static
}

sha512sums="978876605b5bbef83879ce336296b4fe80c597b4ac1a152384ce2605fac2102a02a418e1d0389a9ca2d2cb38b9bc07d1cf5d64f12a1b5644a65d80ce99eb4ec6  lua-resty-jsonb-0.0.5.tar.gz"
