# Contributor: Yichun Zhang <admin@openresty.com>
# Maintainer: Yichun Zhang <admin@openresty.com>
pkgname="openresty-luajit-plus"
pkgver="20240628"
pkgrel=0
pkgdesc="enhanced Luajit developed by OpenResty Inc."
url="https://openresty.com/"
arch="all"
license="Proprietary"
#depends=""
#makedepends=""
#install=""
subpackages="$pkgname-dev $pkgname-dbg"
source="luajit2-plus-plus-v2.1-$pkgver.tar.gz"
options="!tracedeps !fhs"
builddir="$srcdir/luajit2-plus-plus-v2.1-$pkgver"

prefix=/usr/local/openresty/luajit-plus

build() {
    export CC="gcc"
    export CFLAGS=
    export CXXFLAGS=
    export CPPFLAGS=
    export LDFLAGS=

    make -j$JOBS CCDEBUG=-g XCFLAGS='-DLUAJIT_NUMMODE=2 -DLUAJIT_ENABLE_LUA52COMPAT -g -DLUAJIT_ENABLE_GC64' Q= PREFIX=$prefix
}

check() {
	:
}

package() {
    make install DESTDIR="$pkgdir" PREFIX=$prefix
    rm -rf $pkgdir/$prefix/share/man
    rm -rf $pkgdir/$prefix/lib/libluajit-5.1.a
    
    cd $pkgdir
    pwd
    
    for f in `find .$prefix/ -type f -name '*.lua'`; do
        echo $f
        LUA_PATH="$pkgdir/$prefix/share/luajit-2.1/?.ljbc;$pkgdir/$prefix/share/luajit-2.1/?.lua;;" $pkgdir/$prefix/bin/luajit -bg $f ${f%.lua}.ljbc
        rm -f $f
    done

}

static() {
    if ! is_function default_static; then
        local i= devpkg

        # search for -dev package matching our prefix
        if [ -z "$depends_static" ]; then
            devpkg="${subpkgname%-libs-static}"
            devpkg="${devpkg%-static}"
            devpkg="$devpkg-dev"
            if subpackages_has "$devpkg"; then
                depends_static="$devpkg"
            fi
        fi

        depends="$depends_static"
        pkgdesc="$pkgdesc (static library)"

        cd "$pkgdir" || return 0
        local libdirs=usr/lib
        [ -d lib/ ] && libdirs="lib/ $libdirs"

        # move *.a static library
        for i in $(find $libdir -name '*.a'); do
            mkdir -p "$subpkgdir"/"${i%/*}"
            mv "$i" "$subpkgdir/$i" || return 1
        done
        return 0
    fi

    default_static
}

sha512sums="0f76aef95e4c20ca6b28ef151cb6210d0f08b75bba0b806271892a79db17e4bd7fb162b9d5134827e4bdae0f7c69b50a430156fe113b2f8e7d371333fc6d2f63  luajit2-plus-plus-v2.1-20240628.tar.gz"
