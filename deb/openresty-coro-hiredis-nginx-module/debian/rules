#!/usr/bin/make -f

DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

export NO_PKG_MANGLE=1
export QA_RPATHS=$[ 0x0002 ]

export zlib_prefix         /usr/local/openresty/zlib
export pcre_prefix         /usr/local/openresty/pcre
export openssl_prefix      /usr/local/openresty/openssl111
export elfutils_prefix      /usr/local/openresty-elfutils

DESTDIR = $(CURDIR)/debian/tmp

%:
	dh $@ --parallel --with autotools-dev

override_dh_auto_test:

override_dh_usrlocal:

override_dh_auto_configure:

override_dh_auto_build:
	cd openresty-*/ && ./configure \
    --with-cc='ccache gcc' \
    --with-cc-opt="-DNGX_HTTP_CORO_USE_FREE_LISTS -I$(zlib_prefix)/include -I$(pcre_prefix)/include -I$(openssl_prefix)/include -I$(elfutils_prefix)/include -I/usr/local/elf-loader/include -I/usr/local/openresty-coro-nginx-module/include -I/usr/local/openresty-plus/hiredis/include" \
    --with-ld-opt="-L$(zlib_prefix)/lib -I$(pcre_prefix)/lib -I$(openssl_prefix)/lib -L$(elfutils_prefix)/lib -L/usr/local/elf-loader/lib -L/usr/local/openresty-coro-nginx-module/lib -Wl,-rpath,$(zlib_prefix)/lib:$(pcre_prefix)/lib:$(openssl_prefix)/lib:$(elfutils_prefix)/lib:/usr/local/elf-loader/lib:/usr/local/openresty-coro-nginx-module/lib" \
    --with-compat \
    --add-dynamic-module=../ \
    -j`nproc` && \
	make -C build/nginx-*/ modules -j`nproc`

	for f in `find lualib/resty/ -type f -name '*.lua'`; do \
		/usr/local/openresty/luajit/bin/luajit -bg $$f $${f%.lua}.ljbc; \
		rm $$f; \
	done

override_dh_auto_install:
	rm -rf $(DESTDIR)
	mkdir -p $(DESTDIR)/usr/local/openresty-coro-nginx-module/lib
	mkdir -p $(DESTDIR)/usr/local/openresty/site/lualib/resty
	cd openresty-* && install -m755 build/nginx-*/objs/*.so $(DESTDIR)/usr/local/openresty-coro-nginx-module/lib/
	sed -i 's|lib/resty/\*.lua|lib/resty/\*.ljbc|g' Makefile
	make install DESTDIR=$(DESTDIR) LUA_LIB_DIR=/usr/local/openresty/site/lualib

override_dh_auto_clean:
	dh_clean
	rm -rf $(DESTDIR)

override_dh_strip:
	dh_strip --dbg-package=openresty-coro-hiredis-nginx-module-dbgsym
