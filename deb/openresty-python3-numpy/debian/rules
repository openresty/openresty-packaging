#!/usr/bin/make -f

DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

export NO_PKG_MANGLE=1
export QA_RPATHS=$[ 0x0002 ]

DESTDIR = $(CURDIR)/debian/tmp

%:
	dh $@ --parallel --with autotools-dev,systemd

override_dh_auto_test:

override_dh_usrlocal:

override_dh_auto_configure:

override_dh_auto_build:
	if [ -z "$$(command -v $(HOME)/.local/bin/pip3)" ]; then \
		wget -O get-pip.py https://bootstrap.pypa.io/get-pip.py; \
		python3 get-pip.py; \
	fi
	if [ -z "$$(command -v $(HOME)/.local/bin/meson)" ]; then \
		pip3 install --user meson; \
	fi
	if [ -z "$$(command -v $(HOME)/.local/bin/spin)" ]; then \
		pip3 install --user spin; \
	fi
	if [ -z "$$(command -v $(HOME)/.local/bin/ninja)" ]; then \
		pip3 install --user ninja; \
	fi

	export ATLAS=None; \
		export BLAS=/usr/lib; \
		export LAPACK=/usr/lib; \
		CFLAGS= CXXFLAGS= PATH="/usr/local/openresty-python3/bin:$(PATH)" spin build  -j`nproc` -- --prefix=/usr/local/openresty-python3

override_dh_auto_install:
	export ATLAS=None; \
		export FFTW=/usr/lib; \
		export BLAS=/usr/lib; \
		export LAPACK=/usr/lib; \
		rm -rf build-install/usr/local/openresty-python3/lib/python3.12/site-packages/numpy/{compat,core,distutils,f2py,fft,lib,linalg,ma,matrixlib,polynomial,random,testing}/tests \
		&& install -d $(DESTDIR) && cp -ra build-install/* $(DESTDIR)/

override_dh_auto_clean:
	dh_clean
	rm -rf $(DESTDIR)

override_dh_strip:
	dh_strip --dbg-package=openresty-python3-numpy-dbgsym
