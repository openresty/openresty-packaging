#!/usr/bin/make -f
DPKG_EXPORT_BUILDFLAGS = 1
hyperscan_prefix = /usr/local/openresty-plus/hyperscan

include /usr/share/dpkg/default.mk

export NO_PKG_MANGLE=1
export QA_RPATHS=$[ 0x0002 ]

DESTDIR = $(CURDIR)/debian/tmp

%:
	dh $@ --parallel --with autotools-dev

override_dh_auto_configure:
	CC='ccache gcc' \
	CXX='ccache g++' \
	cmake -DCMAKE_INSTALL_PREFIX:PATH=$(hyperscan_prefix) \
		-DBUILD_SHARED_LIBS=true .

override_dh_usrlocal:

override_dh_auto_install:
	dh_auto_install
	rm -rf $(DESTDIR)/usr/share/doc
	if [ -d $(DESTDIR)/$(hyperscan_prefix)/lib/x86_64-linux-gnu/ ]; then \
		mv $(DESTDIR)/$(hyperscan_prefix)/lib/x86_64-linux-gnu/* $(DESTDIR)/$(hyperscan_prefix)/lib/ || exit 1; \
		rm -rf $(DESTDIR)/$(hyperscan_prefix)/lib/x86_64-linux-gnu/ || exit 1; \
	fi

	mkdir -p $(DESTDIR)/usr/local/openresty-plus/lualib/
	ln -sf $(hyperscan_prefix)/lib/libhs.so $(DESTDIR)/usr/local/openresty-plus/lualib/
	ln -sf $(hyperscan_prefix)/lib/libhs_runtime.so $(DESTDIR)/usr/local/openresty-plus/lualib/

	mkdir -p $(DESTDIR)/usr/local/openresty-plus-debug/lualib/
	ln -sf $(hyperscan_prefix)/lib/libhs.so $(DESTDIR)/usr/local/openresty-plus-debug/lualib/
	ln -sf $(hyperscan_prefix)/lib/libhs_runtime.so $(DESTDIR)/usr/local/openresty-plus-debug/lualib/

override_dh_install:
	dh_install

override_dh_strip:
	dh_strip --dbg-package=openresty-plus-hyperscan-dbgsym
