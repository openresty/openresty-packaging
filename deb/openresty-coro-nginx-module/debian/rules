#!/usr/bin/make -f

DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

export NO_PKG_MANGLE=1
export QA_RPATHS=$[ 0x0002 ]

export zlib_prefix         /usr/local/openresty/zlib
export pcre_prefix         /usr/local/openresty/pcre
export openssl_prefix      /usr/local/openresty/openssl111
export elfutils_prefix      /usr/local/openresty-elfutils

DESTDIR = $(CURDIR)/debian/tmp

%:
	dh $@ --parallel --with autotools-dev

override_dh_auto_test:

override_dh_usrlocal:

override_dh_auto_configure:

override_dh_auto_build:
	cd openresty-*/ && ./configure \
    --prefix="/usr/local/openresty-coro-nginx-module" \
    --with-cc='ccache gcc' \
    --with-cc-opt="-DNGX_HTTP_CORO_USE_FREE_LISTS -I$(zlib_prefix)/include -I$(pcre_prefix)/include -I$(openssl_prefix)/include -I$(elfutils_prefix)/include -I/usr/local/elf-loader/include -I/usr/local/libcco/include" \
    --with-ld-opt="-L$(zlib_prefix)/lib -I$(pcre_prefix)/lib -I$(openssl_prefix)/lib -L$(elfutils_prefix)/lib -L/usr/local/elf-loader/lib -L/usr/local/libcco/lib -Wl,-rpath,$(zlib_prefix)/lib:$(pcre_prefix)/lib:$(openssl_prefix)/lib:$(elfutils_prefix)/lib:/usr/local/elf-loader/lib:/usr/local/libcco/lib" \
    --with-compat \
    --add-dynamic-module=../ \
    -j`nproc` && \
	make -C build/nginx-*/ modules -j`nproc`

override_dh_auto_install:
	rm -rf $(DESTDIR)
	mkdir -p $(DESTDIR)/usr/local/openresty-coro-nginx-module/lib
	mkdir -p $(DESTDIR)/usr/local/openresty-coro-nginx-module/include
	cd openresty-*/ && \
		install -m755 build/nginx-*/objs/*.so $(DESTDIR)/usr/local/openresty-coro-nginx-module/lib/ && \
		install -m644 ../src/api/*.h $(DESTDIR)/usr/local/openresty-coro-nginx-module/include/

override_dh_auto_clean:
	dh_clean
	rm -rf $(DESTDIR)

override_dh_strip:
	dh_strip --dbg-package=openresty-coro-nginx-module-dbgsym
